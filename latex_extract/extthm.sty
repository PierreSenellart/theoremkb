\RequirePackage{amsgen}
\RequirePackage{etextools}
\RequirePackage{trace}

\newcounter{propcounter}

% To remove \hbox in output
\def\@setref#1#2#3{%
  \ifx#1\relax
   \protect\G@refundefinedtrue
   \nfss@text{\reset@font\bfseries ??}%
   \@latex@warning{Reference `#3' on page \thepage \space
             undefined}%
  \else
   \expandafter#2#1
  \fi}

\let\oldnewtheorem\newtheorem
\def\newtheorem{%
  \@ifstar\newtheoremstar\newtheoremnostar
}
\def\newtheoremstar#1#2{%
  \oldnewtheorem*{#1}{#2}%
  \definemytheorem{#1}{#2}%
}


\newcommand\newtheoremnostar[1]{%
  \@oparg{\newtheoremnostarinternal{#1}}[]%
}
\def\newtheoremnostarinternal#1[#2]#3{%
  \@oparg{\newtheoremnostartrue{#1}[#2]{#3}}[]%
}
\def\newtheoremnostartrue#1[#2]#3[#4]{%
  \ifx\relax#4\relax
    \ifx\relax#2\relax
      \oldnewtheorem{#1}{#3}%
    \else
      \oldnewtheorem{#1}[#2]{#3}%
    \fi
  \else
    \oldnewtheorem{#1}{#3}[#4]%
  \fi
  \definemytheorem{#1}{#3}%
}

\newsavebox{\extthm@tmpbox}

\newcommand{\definemytheorem}[2]{%
  \expandafter\let\expandafter\temp\csname #1\endcsname %\let\temp"#1"
  \expandafter\global\expandafter\let\csname old#1\endcsname\temp % \global\let\"old#1"\temp

  \expandafter\let\expandafter\temp\csname end#1\endcsname %\let\temp"end#1"
  \expandafter\global\expandafter\let\csname oldend#1\endcsname\temp %\global\let\"oldend#1"\temp

  \expandafter\def\csname #1\endcsname{%
    \addtocounter{propcounter}{1}
    \expandafter\newsavebox\csname extthm@\roman{propcounter}\endcsname%
    \begin{lrbox}{\extthm@tmpbox}%
    \begin{minipage}{\linewidth}
    \csname old#1\endcsname
  }
  \expandafter\def\csname end#1\endcsname{
    \csname oldend#1\endcsname
    \end{minipage}
    \end{lrbox}
    \global\expandafter\setbox\csname extthm@\roman{propcounter}\endcsname=\box \extthm@tmpbox\relax
    \par\noindent\expandafter\usebox\csname extthm@\roman{propcounter}\endcsname
    \AtEndDocument{\clearpage extthm extraction follows\clearpage\noindent\usebox}
    \expandafter\AtEndDocument\csname extthm@\roman{propcounter}\endcsname
  }
}
